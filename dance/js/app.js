$("#message").hide();var video;var started=false;function hasGetUserMedia(){return !!(navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia)}function start_media(){if(hasGetUserMedia()){$("#start_button").hide();$("#message").show()}else{$("#message").hide();return}var A=function(C){alert("Webcam error!",C)};video=document.getElementById("webcam");if(navigator.webkitGetUserMedia){try{navigator.webkitGetUserMedia({audio:true,video:true},function(C){console.log("User has granted access to local media.");video.src=window.webkitURL.createObjectURL(C);initialize()},A)}catch(B){navigator.webkitGetUserMedia("audio, video",function(C){console.log("User has granted access to local media (old version).");video.src=window.webkitURL.createObjectURL(C);initialize()},A)}}else{}}var AudioContext=(window.AudioContext||window.webkitAudioContext||null);var notesPosX=[0,544,0,544];var notesPosY=[0,0,360,360];var timeOut,lastImageData;var canvasSource=$("#canvas-source")[0];var canvasBlended=$("#canvas-blended")[0];var contextSource=canvasSource.getContext("2d");var contextBlended=canvasBlended.getContext("2d");var soundContext;var bufferLoader;var notes=[];var buttons=[];var score=0;var currentNote;var touched=false;var multiplier=1;var hitsOnARow=0;var comboMessage="";var songEnded=true;contextSource.translate(canvasSource.width,0);contextSource.scale(-1,1);var c=5;function initialize(){if(!AudioContext){alert("AudioContext not supported!")}else{loadVisuals();window.setInterval(function(){document.getElementById("score").innerHTML="Score: "+score;document.getElementById("combo").innerHTML=comboMessage},1000)}}function loadSounds(){soundContext=new AudioContext();bufferLoader=new BufferLoader(soundContext,["sounds/80snare2.mp3","sounds/909kick!.mp3","sounds/AOW CP.mp3","sounds/b4_cng_osp_r20.mp3",],finishedLoading);bufferLoader.load()}function finishedLoading(A){for(var B=0;B<4;B++){var D=soundContext.createBufferSource();D.buffer=A[B];D.connect(soundContext.destination);var C={note:D,ready:true,visual:$("#button"+B)[0]};C.area={x:notesPosX[B],y:notesPosY[B],width:C.visual.width,height:100};notes.push(C)}start()}function loadVisuals(){for(var B=0;B<4;B++){var C={ready:true,visual:$("#button"+B)[0]};C.area={x:notesPosX[B],y:notesPosY[B],width:C.visual.width,height:100};notes.push(C)}var A={ready:true,visual:$("#start0_front")[0]};A.area={x:295,y:0,width:A.visual.width,height:100};buttons.push(A);start()}function playSound(B){if(!B.ready){return}var A=soundContext.createBufferSource();A.buffer=B.note.buffer;A.connect(soundContext.destination);A.noteOn(0);B.ready=false;setTimeout(setNoteReady,400,B)}function setNoteReady(A){A.ready=true}function start(){$(canvasSource).show();$(canvasBlended).hide();$("#buttons").show();$("#message").hide();update()}function update(){drawVideo();blend();checkAreas();timeOut=setTimeout(update,1000/60)}function drawVideo(){contextSource.drawImage(video,0,0,video.width,video.height)}function blend(){var C=canvasSource.width;var A=canvasSource.height;var D=contextSource.getImageData(0,0,C,A);if(!lastImageData){lastImageData=contextSource.getImageData(0,0,C,A)}var B=contextSource.createImageData(C,A);differenceAccuracy(B.data,D.data,lastImageData.data);contextBlended.putImageData(B,0,0);lastImageData=D}function fastAbs(A){return(A^(A>>31))-(A>>31)}function threshold(A){return(A>21)?255:0}function difference(C,A,D){if(A.length!=D.length){return null}var B=0;while(B<(A.length*0.25)){C[4*B]=A[4*B]==0?0:fastAbs(A[4*B]-D[4*B]);C[4*B+1]=A[4*B+1]==0?0:fastAbs(A[4*B+1]-D[4*B+1]);C[4*B+2]=A[4*B+2]==0?0:fastAbs(A[4*B+2]-D[4*B+2]);C[4*B+3]=255;++B}}function differenceAccuracy(E,B,G){if(B.length!=G.length){return null}var C=0;while(C<(B.length*0.25)){var A=(B[4*C]+B[4*C+1]+B[4*C+2])/3;var F=(G[4*C]+G[4*C+1]+G[4*C+2])/3;var D=threshold(fastAbs(A-F));E[4*C]=D;E[4*C+1]=D;E[4*C+2]=D;E[4*C+3]=255;++C}}function checkAreas(){if(started==true){for(var D=0;D<4;++D){var A=contextBlended.getImageData(notes[D].area.x,notes[D].area.y,notes[D].area.width,notes[D].area.height);var B=0;var C=0;while(B<(A.data.length*0.25)){C+=(A.data[B*4]+A.data[B*4+1]+A.data[B*4+2])/3;++B}C=Math.round(C/(A.data.length*0.25));if(C>10){notes[D].visual.style.display="block";$(notes[D].visual).fadeOut();if(!touched){touched=true;if(D==currentNote){if(++hitsOnARow%5==0){multiplier+=0.1;switch(hitsOnARow){case 5:comboMessage="Good!";break;case 10:comboMessage="Excellent!";break;case 15:comboMessage="Marvelous!";break;case 50:comboMessage="Mooooonster!!!";break}console.log(comboMessage)}score+=50*multiplier;console.log("hit");if(currentNote!=null){document.getElementById("circle"+currentNote).style.display="none"}}else{score-=25;console.log("miss");if(currentNote!=null){document.getElementById("circle"+currentNote).style.display="none";document.getElementById("chroma").style.display="block";console.log("I am here");multiplier=1;hitsOnARow=0}}console.log("Score: "+score+" Multiplier: "+multiplier)}}}}else{if(started==false){var A=contextBlended.getImageData(buttons[0].area.x,buttons[0].area.y,buttons[0].area.width,buttons[0].area.height);var B=0;var C=0;while(B<(A.data.length*0.25)){C+=(A.data[B*4]+A.data[B*4+1]+A.data[B*4+2])/3;++B}C=Math.round(C/(A.data.length*0.25));if(C>10){start_game();buttons[0].visual.style.display="block";$(buttons[0].visual).fadeOut()}}}}var counter=false;var check=false;function start_game(){if(counter==true){console.log("Start game");document.getElementById("start").style.display="none";document.getElementById("start_front").style.display="none";songEnded=false;if(check==false){check=true;countDown()}}counter=true}var count=4;function countDown(){if(count==4){document.getElementById("n3").style.display="block";count=count-1}else{if(count==3){document.getElementById("n3").style.display="none";document.getElementById("n2").style.display="block";count=count-1}else{if(count==2){document.getElementById("n2").style.display="none";document.getElementById("n1").style.display="block";count=count-1}else{if(count==1){document.getElementById("n1").style.display="none";count--;audio.play();started=true;setTimeout(genNote,2000)}}}}if(count>0){setTimeout(countDown,1000)}}var oldNote=null;function genNote(){comboMessage="";if(oldNote!=null){if(document.getElementById("chroma").style.display=="block"){document.getElementById("chroma").style.display="none"}document.getElementById("circle"+oldNote).style.display="none"}currentNote=Math.floor(Math.random()*4);oldNote=currentNote;if(!touched){multiplier=1;hitsOnARow=0}else{touched=false;console.log("current note"+currentNote)}document.getElementById("circle"+currentNote).style.display="block";if(!songEnded){setTimeout(genNote,2000)}}function endSong(){songEnded=true;document.getElementById("circle"+oldNote).style.display="none";window.location="/results.html?score="+score};